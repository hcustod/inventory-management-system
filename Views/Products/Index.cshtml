@model List<InventoryManagementSystem.Models.Product>
@using Microsoft.AspNetCore.Identity
@inject SignInManager<User> SignInManager
@inject UserManager<User> UserManager

@{
    ViewData["Title"] = "Product Inventory";
}

<h2>Product Inventory</h2>

<h5 class="mt-3">Search for Products Below</h5>

<!-- Search and filtering -->
<form id="filterForm" method="get" class="mb-3">
    <div class="row g-3 align-items-center">
        <!-- Search -->
        <div class="col-md-3">
            <input type="text" name="search" id="search" class="form-control" placeholder="Search by Name">
        </div>
        
        <!-- Category -->
        <div class="col-md-3">
            <select name="categoryId" id="categoryId" class="form-control">
                <option value="">All Categories</option>
                @foreach (var category in ViewBag.Categories)
                {
                    <option value="@category.Id">@category.CategoryName</option>
                }
            </select>
        </div>

        <!-- Min and Max price -->
        <div class="col-md-2">
            <input type="number" name="minPrice" id="minPrice" class="form-control" placeholder="Min Price">
        </div>
        <div class="col-md-2">
            <input type="number" name="maxPrice" id="maxPrice" class="form-control" placeholder="Max Price">
        </div>

        <!-- Sorting -->
        <div class="col-md-2">
            <select name="sortBy" id="sortBy" class="form-control">
                <option value="">Sort By</option>
                <option value="price">Price</option>
                <option value="quantity">Stock</option>
                <option value="name">Name</option>
            </select>
        </div>
        
        <!-- Go and reset button -->
        <div class="row mt-2">
            <div class="col-md-12">
                <button type="submit" class="btn btn-primary">GO</button>
                <button type="reset" class="btn btn-secondary" id="resetFilters">Reset</button>
            </div>
        </div>

        <!-- Low stock toggle button -->
        <div class="col-md-2">
            <input type="hidden" name="lowStockOnly" id="lowStockOnly" value="false">
            <button type="button" id="lowStockBtn" class="btn btn-outline-danger w-100"> Low Stock Only</button>
        </div>
    </div>
</form>


<!-- Add product and category buttons - only visible to admins -->
@if (User.IsInRole("Admin"))
{
    <div class="mb-3">
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createProductModal">Add Product</button>
        <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#categoryModal">Manage Categories</button>
    </div>
}


<!-- Categories Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryModalLabel">Manage Categories</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Add Category  -->
                <div class="mb-3">
                    <label for="newCategory" class="form-label">Category Name</label>
                    <input type="text" id="newCategory" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="newCategoryDesc" class="form-label">Category Description</label>
                    <input type="text" id="newCategoryDesc" class="form-control" required>
                </div>
                <button id="addCategoryBtn" class="btn btn-primary">Add Category</button>

                <hr>

                <!-- Existing Categories display -->
                <h6>Existing Categories</h6>
                <ul id="categoryList" class="list-group">
                    <!-- Categories will be inserted here -->
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCategoryModalLabel">Edit Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editCategoryForm">
                    <input type="hidden" id="editCategoryId">
                    <div class="mb-3">
                        <label for="editCategoryName" class="form-label">Category Name</label>
                        <input type="text" id="editCategoryName" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCategoryDesc" class="form-label">Category Description</label>
                        <input type="text" id="editCategoryDesc" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
</div>

<hr class="my-4">

<!-- Show all products table  -->
<table class="table table-bordered">
    <thead>
    <tr>
        <th>Name</th>
        <th>Category</th>
        <th>Price ($)</th>
        <th>Stock</th>
        <th>Stock Status</th>
        @if (User.IsInRole("Admin"))
          {
              <th>Actions</th>
          }
    </tr>
    </thead>
    <tbody id="productTableBody">
    @if (Model != null && Model.Any()) 
    {
        @foreach (var product in Model)
        {
            <tr>
                <td>@product.Name</td>
                <td>@(product.Category != null ? product.Category.CategoryName : "Uncategorized")</td>
                <td>@product.Price</td>
                <td>@product.ProductStockAmount</td>
                <td>
                    @if (product.ProductStockAmount < product.LowStockThreshold)
                    {
                        <span style="display:inline-block;width:20px;height:20px;background-color:red;border-radius:3px;" title="Low Stock"></span>
                    }
                    else
                    {
                        <span style="display:inline-block;width:20px;height:20px;background-color:green;border-radius:3px;" title="Stock OK"></span>
                    }
                </td>
                <!-- Only show action col for admin --> 
                @if (User.IsInRole("Admin"))
                {
                    <td>
                        <!-- Only show buttons for admin --> 
                        @if (User.IsInRole("Admin"))
                        {
                            <button class="btn btn-warning btn-sm edit-product"
                                    data-id="@product.Id"
                                    data-name="@product.Name"
                                    data-desc="@product.Description"
                                    data-category="@product.CategoryId"
                                    data-price="@product.Price"
                                    data-stock="@product.ProductStockAmount"
                                    data-lowstock="@product.LowStockThreshold"
                                    data-bs-toggle="modal" data-bs-target="#editModal">
                                ‚úè Edit
                            </button>
                            <button class="btn btn-danger btn-sm delete-product"
                                    data-id="@product.Id"
                                    data-bs-toggle="modal" data-bs-target="#deleteModal">
                                Delete
                            </button>
                        }
                    </td> 
                }
         
            </tr>
        }
    }
    else
    {
        <tr>
            <td colspan="6" class="text-center">No products available.</td>
        </tr>
    }
    </tbody>
</table>

<!-- Spinner symbol -->
<div id="loading" style="display:none;" class="text-center my-3">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>


<!-- Create product modal -->
<div class="modal fade" id="createProductModal" tabindex="-1" aria-labelledby="createProductModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createProductModalLabel">Create Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createProductForm">
                    <div class="mb-3">
                        <label>Name:</label>
                        <input type="text" id="createProductName" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label>Description:</label>
                        <input type="text" id="createProductDesc" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label>Category:</label>
                        <select id="createProductCategory" class="form-control">
                            @foreach (var category in ViewBag.Categories)
                            {
                                <option value="@category.Id">@category.CategoryName</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Price:</label>
                        <input type="number" id="createProductPrice" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label>Stock Quantity:</label>
                        <input type="number" id="createProductStock" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label>Low Stock Threshold:</label>
                        <input type="number" id="createProductLowStock" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Product</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit product modal-->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProductForm">
                    <input type="hidden" id="editProductId">

                    <div class="mb-3">
                        <label for="editProductName" class="form-label">Product Name</label>
                        <input type="text" id="editProductName" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label for="editProductDesc" class="form-label">Description</label>
                        <input type="text" id="editProductDesc" class="form-control" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editProductCategory" class="form-label">Category</label>
                        <select id="editProductCategory" class="form-control">
                            @foreach (var category in ViewBag.Categories)
                            {
                                <option value="@category.Id">@category.CategoryName</option>
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="editProductPrice" class="form-label">Price ($)</label>
                        <input type="number" id="editProductPrice" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label for="editProductStock" class="form-label">Stock Quantity</label>
                        <input type="number" id="editProductStock" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label for="editProductLowStock" class="form-label">Low Stock Threshold</label>
                        <input type="number" id="editProductLowStock" class="form-control" required>
                    </div>

                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- Delete product modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this product?</p>
                
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="confirmDeleteCheckbox">
                    <label class="form-check-label" for="confirmDeleteCheckbox">I confirm the deletion</label>
                </div>
                
                <button id="confirmDeleteBtn" class="btn btn-danger mt-3">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete category confirmation modal -->
<div class="modal fade" id="deleteCategoryModal" tabindex="-1" aria-labelledby="deleteCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Category Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this category? This cannot be undone.</p>
                
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="confirmDeleteCategoryCheckbox">
                    <label class="form-check-label" for="confirmDeleteCategoryCheckbox">
                        I confirm this deletion
                    </label>
                </div>

                <button id="confirmDeleteCategoryBtn" class="btn btn-danger mt-3" disabled>Delete Category</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <!-- Solution for roles not checking correctly for user --> 
    <script>
        window.currentUserRole = "@(User.IsInRole("Admin") ? "Admin" : "User")";
    </script>
    <script src="~/js/products.js"></script>
    <script src="~/js/categories.js"></script>
}
